name: "Check for Updates"
run-name: "Check Version [${{ inputs.branchVer }}]"

on:
  workflow_dispatch:
    inputs:
      branchVer:
        type: choice
        description: Branch version
        options:
          - 3.0
          - 2.6
          - 2.4

permissions:
  contents: write
  packages: write

defaults:
  run:
    shell: bash

jobs:
    check:
        runs-on: ubuntu-24.04
        outputs:
            full_version: ${{ steps.compare.outputs.full_version }}
        steps:
            - name: Print inputs
              run: echo "${{ toJSON(inputs) }}"

            - name: Checkout
              uses: actions/checkout@v5
              with:
                ref: ${{ github.ref_name }}
      
            - name: Get Kea version
              run: | # shell
                inputBranch=${{ inputs.branchVer }}
                inputBranch=${inputBranch/./-}
                # for example, produces "3.0.0-isc20250717111736"
                debian_full_version=$(curl -sLo - https://dl.cloudsmith.io/public/isc/kea-${inputBranch}/deb/debian/dists/bookworm/main/binary-amd64/Packages.gz | \
                    gunzip | \
                    grep -A2 '^Package: isc-kea-dhcp4$' | \
                    grep Version | \
                    sed -E 's/^Version:\s+//g' | \
                    sort | uniq | \
                    tail -1)
                # for example, produces "3.0.0-r20250717111736"
                alpine_full_version=$(curl -sLo - https://dl.cloudsmith.io/public/isc/kea-${inputBranch}/alpine/v3.22/main/x86_64/APKINDEX.tar.gz | \
                    tar xOz APKINDEX | \
                    grep -A 1 P:isc-kea-dhcp4 | \
                    grep 'V:' | \
                    sed 's/V://g' | \
                    sort | uniq | \
                    tail -1)

                echo "debian_full_version=${debian_full_version}" | tee -a $GITHUB_ENV
                echo "alpine_full_version=${alpine_full_version}" | tee -a $GITHUB_ENV
        
            - name: Get committed version
              run: | # shell
                echo "jq_debian=$(jq -r '.["${{ inputs.branchVer }}"].debian' versions.json)" | tee -a $GITHUB_ENV
                echo "jq_alpine=$(jq -r '.["${{ inputs.branchVer }}"].alpine' versions.json)" | tee -a $GITHUB_ENV

            - name: Compare versions
              id: compare
              run: | # shell
                full_version="false"
                [ ! "${debian_full_version}" == "${jq_debian}" ] && \
                    [ $(echo -e "${debian_full_version}\n${jq_debian}" | sort | uniq | tail -1) == "${debian_full_version}" ] && \
                    [ "${full_version}" == "false" ] && \
                    full_version="${debian_full_version}" || true
                [ ! "${alpine_full_version}" == "${jq_alpine}" ] && \
                    [ $(echo -e "${alpine_full_version}\n${jq_alpine}" | sort | uniq | tail -1) == "${alpine_full_version}" ] && \
                    [ "${full_version}" == "false" ] && \
                    full_version="${alpine_full_version}" || true

                content=$(jq ".[\"${{ inputs.branchVer }}\"].debian = \"${debian_full_version}\" | .[\"${{ inputs.branchVer }}\"].alpine = \"${alpine_full_version}\"" versions.json) && \
                    echo -E "${content}" > versions.json
                
                # for example, produces "3.0.1-isc20250820123020"
                echo "full_version=${full_version}" | tee -a $GITHUB_OUTPUT
                # for example, produces "3.0.1"
                echo "semVer=${full_version%%-*}" | tee -a $GITHUB_ENV
                # for example, produces "20250820123020"
                echo "dateVersion=$(echo ${full_version##*-} | sed -E 's/(isc|r)//g')" | tee -a $GITHUB_ENV

            - name: Commit changes
              if: ${{ env.semVer != 'false' }}
              uses: EndBug/add-and-commit@v9
              with:
                add: versions.json
                default_author: github_actions
                message: "Update version to v${{ env.semVer }} (${{ env.dateVersion }})"

    callworkflow:
        if: ${{ needs.check.outputs.full_version != 'false' && !(cancelled() || contains(needs.*.result, 'cancelled') || contains(needs.*.result, 'failure')) }}
        needs: [check]
        uses: ./.github/workflows/multiarch.yml
        secrets: inherit
        with:
            publish: true
            binary: dhcp4
            branchVer: ${{ inputs.branchVer }}
            version: ${{ needs.check.outputs.full_version }}
            admin: true
            cacheInvalidatorUpgrade: true
            cacheInvalidator: false
